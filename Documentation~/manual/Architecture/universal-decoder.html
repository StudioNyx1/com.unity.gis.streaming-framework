<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);  })(window,document,'script','dataLayer','GTM-5V25JL6');</script>
    <script type="text/javascript">thisPackageMetaData = { name: "com.unity.gis.streaming-framework", version: "1.0.0", displayTitle:"Unity Geospatial Streaming 1.0.0", lang: "en" };</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
  
    <title>Universal Decoder | Unity Geospatial Streaming | 1.0.0 </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Universal Decoder | Unity Geospatial Streaming | 1.0.0 ">
    <meta name="generator" content="docfx 2.58.9.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/statictoc.docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    <meta property="unity:packageTitle" content="Unity Geospatial Streaming | 1.0.0">
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
                <div class="back-to-unity-group">
                  <a class="back-to-unity" href="http://docs.unity3d.com/">docs.unity3d.com</a>
                </div>
              </form>
                
                <ul class="nav level1 navbar-nav">
                      <li class="active">
                          <a href="../../manual/index.html" title="Manual">Manual</a>
                      </li>
                      <li class="">
                          <a href="../../api/index.html" title="Scripting API">Scripting API</a>
                      </li>
                      <li class="">
                          <a href="../../changelog/CHANGELOG.html" title="Changelog">Changelog</a>
                      </li>
                      <li class="">
                          <a href="../../license/LICENSE.html" title="License">License</a>
                      </li>
                </ul>    </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle"></a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <span class="expand-stub"></span>
                      <a href="../index.html" title="GIS Streaming Framework" class="">GIS Streaming Framework</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../index.html" title="Getting Started" class="">Getting Started</a>
                              
                              <ul class="nav level3">
                                <li class="">
                                  <a href="../GettingStarted/first-time-setup.html" title="First Time Setup" class="">First Time Setup</a>
                                </li>
                                <li class="">
                                  <a href="../GettingStarted/frequently-asked.html" title="Frequently Asked Questions" class="">Frequently Asked Questions</a>
                                </li>
                                <li class="">
                                  <a href="../GettingStarted/known-limitations.html" title="Known Limitations" class="">Known Limitations</a>
                                </li>
                              </ul>  </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../index.html" title="Dataset Formats" class="">Dataset Formats</a>
                              
                              <ul class="nav level3">
                                <li class="">
                                  <a href="../FileFormats/ogc-3d-tiles.html" title="OGC 3D Tiles" class="">OGC 3D Tiles</a>
                                </li>
                                <li class="">
                                  <a href="../FileFormats/tms.html" title="Terrain Management System" class="">Terrain Management System</a>
                                </li>
                              </ul>  </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../index.html" title="Internal Architecture" class="">Internal Architecture</a>
                              
                              <ul class="nav level3">
                                <li class="active">
                                  <a href="../Architecture/universal-decoder.html" title="Universal Decoder" class="active">Universal Decoder</a>
                                </li>
                                <li class="">
                                  <a href="../Architecture/material-factory.html" title="Material Factory" class="">Material Factory</a>
                                </li>
                              </ul>  </li>
                        </ul>  </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="universal-decoder">Universal Decoder</h1>

<p>The universal decoder is a decoder implementation that has the intent of 
supporting many different content types within the same decoder, provided the
given content is HLODed and can be represented within a bounding volume
hierarchy. In its current state, the Universal decoder can be used to decode
a subset of the 3DTiles specification, GLTF files as well as Unity GIS terrain
data.</p>
<h2 id="internal-structure">Internal Structure</h2>
<p>Looking at the internal structure of the Universal Decoder class, we can see
that it is composed of many simple classes that each play their own role in
spatializing and loading pieces of content. Let us go over them in order to 
better understand their roles and responsibilities.</p>
<ul>
<li><strong>DetailObserverData</strong>: The <code>DetailObserverData</code> class is the starting point for 
any decoder. It represents cameras and sensors in the scene such that we can 
determine how much detail is required at any point in space.</li>
<li><strong>TargetStateController</strong>: The <code>TargetStateController</code> uses the
<code>DetailObserverData</code> in order to determine which parts of the <code>BoundingVolumeHierarchy</code>
needs to be expanded and further detailed and which parts should be collapsed, 
removing detail and, thus, reducing the overall memory footprint. The 
<code>HierarchyTargetControl</code>, sets the target state of each node in the hierarchy 
such that the target state represents the steady state of the hierarchy.</li>
<li><strong>BoundingVolumeHierarchy</strong>: The <code>BoundingVolumeHierarchy</code> simply represents the
state of system. All of the information relating to each node is contained 
within the hierarchy. However, the hierarchy is a passive class that does not
do any processing.</li>
<li><strong>CurrentStateController</strong>: The <code>CurrentStateController</code> translates commands
to load, unload, show and hide nodes such that both the current state in the
BVH is up-to-date and so that the corresponding instructions have been sent to
the <code>UGContentManager</code>.</li>
<li><strong>ExpansionScheduler</strong>: The <code>ExpansionScheduler</code> observes the target state of 
each node and determines the order in which they should be expanded and/or 
collapsed in order to maximize the level of detail seen by the user as well 
as keep the system as reactive as possible when cameras change positions. It 
has a readonly relationship with the hierarchy (with the exception of a cache 
it can use to store implementation-specific data) and interacts with the 
<code>CurrentStateController</code> to change the state of the hierarchy.</li>
<li><strong>UGContentManager</strong>: The <code>UGContentManager</code> makes use of multiple registered
<code>UGContentLoader</code> in order to load nodes of various content types. It is also
responsible for building a simultaneous download queue such that multiple 
<code>UGContentLoader</code>, which can be blocked temporarily by external resources, can work
in parallel.</li>
<li><strong>UGCommandBuffer</strong>: The <code>UGCommandBuffer</code> allows content loaders to work on
threads that are separate from the main thread and resynchronizes a series
of output commands with the main thread. This way, mesh, texture and
material data can be deserialized off of the main thread, but be instantiate
using UnityEngine types on the main thread.</li>
</ul>
<p><em>Note: For the sake of simplicity, the diagram below does not illustrate the 
interfaces that link the classes to one another. For this purpose, detailed 
diagrams have been added in the subsequent sections of this document.</em></p>
<p><img src="../images/Architecture/UniversalDecoder/HighLevelClassDiagram.png" alt=""></p>
<h3 id="bounding-volume-hierarchy">Bounding Volume Hierarchy</h3>
<p>The <code>BoundingVolumeHierarchy</code> is responsible for storing data pertaining to each
node in the BVH as well as their target state and current state. Its only 
purpose is to represent the state and relation of the nodes in memory.</p>
<p>This class is broken into four separate interfaces to limit how external classes
can affect the BVH:</p>
<ul>
<li><strong>IEditHierarchyNodes</strong>: Allows external classes to add and
remove nodes from the BVH. This is primarily be used by the UniversalDecoder
class for initialization as well as various <code>UGContentLoader</code> in order to
dynamically expand the size of the BVH.</li>
<li><strong>IEditTargetState</strong>: Allows the <code>TargetStateController</code> to read the information
required to determine and set the target state of each node.</li>
<li><strong>IEditCurrentState</strong>: Allows the <code>CurrentStateController</code> to set the current
state of the node as well as query a node&#39;s <code>NodeContent</code> such that it can
also trigger the loading process.</li>
<li><strong>IPrioritizeHierarchy</strong>: Allows the <code>CompansionScheduler</code> to read the target state of
each node of the hierarchy, information pertaining to the node&#39;s error as well
a cache that the <code>CompansionScheduler</code> can use to store data required for its internal
logic. Other than the aforementioned cache, this interface is essentially 
readonly.</li>
</ul>
<p><img src="../images/Architecture/UniversalDecoder/Hierarchy.png" alt=""></p>
<h3 id="target-state-controller-class">Target State Controller Class</h3>
<p>The <code>TargetStateController</code> communicates with the <code>IEditHierarchyTargetState</code>
interface, which allows it to explore the hierarchy, obtain information pertaining
to each node&#39;s geometric error and bounding volume in order to compute a target
state as well as an error specification.</p>
<p>The responsibility of computing the error specification has not be separated from
that of computing the target state because, for the sake of computational efficiency,
we do not want to be computing the error specification for all nodes, we simply want
to compute the error specification of any node which has a parent with an expanded
target state. The error specification of other nodes is irrelevant and does not
need to be computed, thus saving a tremendous amount of CPU time.</p>
<p>The <code>TargetStateController</code> also needs to receive none or more DetailObserverData.
Should no DetailObserverData be provided, all target states should be set to
unloaded. The <code>DetailObserverData</code> is used to determine whether a node should be
expanded or collapsed, where a result of expanded from one detail observer
supersedes a result of collapsed from another.</p>
<p>Unlike the current state, the target state does not dictate whether a node should
be loaded or not. It only determines whether a node is expanded or collapsed.</p>
<p><img src="../images/Architecture/UniversalDecoder/TargetStateController.png" alt=""></p>
<h3 id="current-state-controller-class">Current State Controller Class</h3>
<p>The <code>CurrentStateController</code> has the purpose of ensuring that the current state
of the hierarchy is always valid and that the corresponding content has been
loaded and has the appropriate visibility status.</p>
<p>It exposes a simple set of methods which allows the <code>CompansionScheduler</code> to expand and
collapse nodes without needing to worry about whether a node is loaded or not
and without needing to worry about which instructions should be sent to the
<code>UGContentManager</code>.</p>
<p>Additionally, it provides information to the <code>CompansionScheduler</code> as to how many nodes
are currently being loaded such that it can throttle the number of nodes to
expand and limit the number of simultaneous web and IO operations.</p>
<p><img src="../images/Architecture/UniversalDecoder/CurrentStateController.png" alt=""></p>
<h3 id="expansionscheduler">ExpansionScheduler</h3>
<p>The <code>ExpansionScheduler</code> observes the difference between each node&#39;s target state
and it&#39;s current state and progressively causes the two to converge. Using the 
error metrics, it also determines the order in which nodes should be collapsed 
and expanded.</p>
<p>It holds an essentially readonly interface to obtain the information it needs from
the BVH and it applies the desired changes via the <code>ICurrentStateController</code>.</p>
<p>The ExpansionScheduler also has a data cache that it can use on each node where it can
store timers or other node-specific variables needed for internal logic.</p>
<p><img src="../images/Architecture/UniversalDecoder/ExpansionScheduler.png" alt=""></p>
<h2 id="bounding-volume-hierarchy-state">Bounding Volume Hierarchy State</h2>
<p>The <code>BoundingVolumeHierarchy</code> relies heavily on the concept of target and 
current state. All nodes have both a target state and a current state.
Understanding how these states relate to each is key to understanding how the
bounding volume hierarchy functions.</p>
<h3 id="target-state">Target State</h3>
<p>The target state represents the steady-state of each node without consideration 
for optimizations. In short, it expresses the visibility of the nodes should the 
DetailObserverData remain unchanging for an infinite amount of time.</p>
<p>It is a binary state that can either be set to <code>Expanded</code> or <code>Collapsed</code>. When
collapsed, this indicates that it&#39;s children should not be visible and that the
content of the given node should be. When expanded, this indicates that it&#39;s
children should be visible but the given node should respect the replacement
mode parameter. However, a change of state may take multiple frames to come into
effect, which brings us to the current state.</p>
<h3 id="current-state">Current State</h3>
<p>The current state represents the actual state of a node and its relevant 
content. Unlike the target state, the current state is not a single binary but
rather a triplet of binary states. Each of these binary states are detailed 
below:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>False</th>
<th>True</th>
</tr>
</thead>
<tbody>
<tr>
<td>Expanded</td>
<td>Collapsed, children are hidden</td>
<td>Expanded, children may be visible</td>
</tr>
<tr>
<td>Loaded</td>
<td>Node content has not yet been loaded</td>
<td>Node content has been loaded</td>
</tr>
<tr>
<td>Visible</td>
<td>Node content is hidden</td>
<td>Node content is visible</td>
</tr>
</tbody>
</table>
<p>Given the above states, it is obvious that some states are not possible and 
cannot make sense. Here are a few cases that need to be safe-guarded against:</p>
<ul>
<li>A node cannot be visible and unloaded, regardless of the expanded state.</li>
<li>If a node is expanded and its refinement mode is additive, it cannot be 
hidden.</li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
